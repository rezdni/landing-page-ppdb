<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>data-pendaftaran</title>
        <link rel="stylesheet" href="../../assets/styles/styles.css" />
        <link rel="stylesheet" href="../../assets/styles/popup.css" />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
            integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
        <!-- CSS Popup -->
        <link rel="stylesheet" href="../../assets/styles/popup.css" />
    </head>
    <body>
        <!-- Menu mobile -->
        <div class="menu-mobile">
            <button class="menu-close">X</button>
            <a href="index.html">
                <i class="fa-solid fa-house"></i>
                <span>Dashboard</span>
            </a>

            <a href="biodata.html">
                <i class="fa-solid fa-user-group"></i>
                <span>Biodata</span>
            </a>

            <a href="edit-akun.html">
                <i class="fa-solid fa-users"></i>
                <span>Edit Akun</span>
            </a>

            <a href="../../logout.php">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </a>
        </div>
        <!-- End menu MObile -->

        <!-- sidebar -->
        <div class="sidebar">
            <ul class="menu">
                <li>
                    <a href="index.html">
                        <i class="fa-solid fa-bars"></i>
                        <span>Menu</span>
                    </a>
                </li>
                <li>
                    <a href="index.html">
                        <i class="fa-solid fa-house"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="biodata.html">
                        <i class="fa-solid fa-user-group"></i>
                        <span>Biodata</span>
                    </a>
                </li>
                <li>
                    <a href="/views/user/edit-akun.html">
                        <i class="fa-solid fa-users"></i>
                        <span>Edit Akun</span>
                    </a>
                </li>
                <li class="logout">
                    <a href="../../logout.php">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
        </div>
        <!-- sidebar -->
        <div class="main--content">
            <div class="header--wrapper">
                <div class="menu-btn">
                    <span class="material-symbols-outlined"> menu </span>
                </div>
                <div class="header--title">
                    <img src="../../assets/images/logo.png" alt="" />
                    <div class="teks">
                        <h2>Edit Akun</h2>
                        <span>SMA AL FASANAH</span>
                    </div>
                </div>
                <!-- search -->
            </div>
            <!-- end sidebar -->
            <!-- list user -->
            <div class="list--wrapper formulir">
                <h3 class="main--title">Edit Akun</h3>
                <div class="list--container">
                    <form action="">
                        <div class="kolom-isi">
                            <label for="nama-pengguna">Nama Pengguna</label>
                            <input
                                type="text"
                                id="nama-pengguna"
                                name="nama-pengguna"
                                maxlength="50"
                                required
                            />
                        </div>

                        <div class="kolom-isi">
                            <label for="email">Email</label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                maxlength="50"
                                required
                            />
                        </div>

                        <div class="kolom-isi">
                            <label for="password">Password</label>
                            <input
                                type="password"
                                id="password"
                                name="password"
                            />
                        </div>

                        <div class="kolom-isi">
                            <label for="ulangi-password">Ulangi Password</label>
                            <input
                                type="password"
                                id="ulangi-password"
                                name="ulangi-password"
                            />
                        </div>

                        <div class="tombol-form">
                            <button
                                type="reset"
                                name="reset"
                                id="reset"
                                onclick="history.back()"
                            >
                                Batal
                            </button>
                            <button
                                type="submit"
                                name="simpan"
                                id="simpan"
                                onclick="simpanPerubahan(this, event)"
                            >
                                Simpan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- end list user -->
        <!-- Popup Notifikasi -->
        <div class="popup">
            <div class="overlay">
                <div class="popup-content">
                    <h2 class="popup-title">This is popup title</h2>
                    <p class="popup-msg">
                        Lorem ipsum, dolor sit amet consectetur adipisicing
                        elit. Veniam blanditiis magnam aut harum et aperiam ea
                        eum nulla? Sed, odit. Voluptatem sed debitis ullam
                        aspernatur aliquam tempora ab magnam illum.
                    </p>
                    <div class="controls">
                        <button class="submit-btn">Submit</button>
                        <button class="close-btn">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- end Popup Notifikasi -->
        <script src="../../assets/scripts/user.js"></script>
        <script src="../../assets/scripts/popup.js"></script>
        <script src="../../assets/scripts/cek-sesi.js"></script>
        <script>
            let namaPengguna = document.getElementById("nama-pengguna");
            let emailPengguna = document.getElementById("email");
            let password = document.getElementById("password");
            let rePassword = document.getElementById("ulangi-password");

            let getXhr = new XMLHttpRequest();
            getXhr.open(
                "GET",
                "../../backend/menu-calon.php?info-akun=true",
                true
            );
            getXhr.setRequestHeader(
                "Content-Type",
                "application/x-www-form-urlencoded"
            );

            getXhr.onload = function () {
                if (getXhr.status === 200) {
                    try {
                        const dataPengguna = JSON.parse(getXhr.responseText);
                        if (dataPengguna.status === "success") {
                            namaPengguna.value = dataPengguna.data.nama;
                            emailPengguna.value = dataPengguna.data.email;
                        } else {
                            showPopup(
                                "Kesalahan",
                                "Terjadi kesalahan",
                                "",
                                "Oke"
                            );
                            console.dir(dataPengguna.message);
                        }
                    } catch (errMsg) {
                        showPopup("Kesalahan", "Terjadi kesalahan", "", "Oke");
                        console.dir({
                            Kesalahan: errMsg,
                            "XMLHttpRequest Respon": getXhr.responseText,
                        });
                    }
                } else {
                    showPopup("Error", "Failed to process data", "", "Ok");
                }
            };

            getXhr.send();

            function simpanPerubahan(tombol, event) {
                event.preventDefault();

                let requiredField =
                    document.querySelectorAll("input[required]");
                let validasi = true;

                // Cek semua kolom diisi kecual password
                requiredField.forEach((element) => {
                    if (!element.checkValidity()) {
                        validasi = false;
                    }
                });

                // Cek jika kolom password di isi dan keduanya sama
                if (password.value !== "" && rePassword.value !== "") {
                    if (password.value !== rePassword.value) {
                        validasi = false;
                    }
                }

                if (validasi) {
                    tombol.innerText = "Menyimpan...";
                    tombol.setAttribute("disabled", "");

                    const formulir = document.querySelector("form");
                    let editAkun = new FormData(formulir);

                    editAkun.append("simpanPerubahan", true);

                    let simpan = new XMLHttpRequest();
                    simpan.open("POST", "../../backend/menu-calon.php", true);

                    simpan.onload = function () {
                        if (simpan.status === 200) {
                            try {
                                tombol.innerText = "Simpan";
                                tombol.removeAttribute("disabled");

                                const respon = JSON.parse(simpan.responseText);
                                if (respon.status == "success") {
                                    showPopup(
                                        "Berhasil",
                                        "Akun berhasil diubah",
                                        "",
                                        "Oke"
                                    );
                                } else if (respon.status === "error") {
                                    showPopup(
                                        "Kesalahan",
                                        "Terjadi kesalahan",
                                        "",
                                        "Oke"
                                    );
                                    console.dir(respon.message);
                                }
                            } catch (errMsg) {
                                showPopup(
                                    "Kesalahan",
                                    "Terjadi kesalahan",
                                    "",
                                    "Oke"
                                );
                                console.dir({
                                    Kesalahan: errMsg,
                                    "XMLHttpRequest Respon":
                                        simpan.responseText,
                                });
                            }
                        } else {
                            showPopup(
                                "Error",
                                "Failed to process data",
                                "",
                                "Ok"
                            );
                        }
                    };

                    simpan.send(editAkun);
                } else {
                    showPopup("Kesalahan", "Mohon isi dengan benar", "", "Oke");
                }
            }

            window.onload = function () {
                cekSesi();
            };
        </script>
    </body>
</html>
